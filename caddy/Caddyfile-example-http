{
    # Disables automatic certificate attempts and redirects
    auto_https off
    admin off

    # Privacy-filtered logging
    log {
        output stderr
        format filter {
            request>remote_ip ip_mask 8 32
            request>client_ip ip_mask 8 32
            request>remote_port delete
            request>headers delete
        }
    }
}

# --- Snippets ---

# Standard security headers
(standard_headers) {
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "no-referrer"
        -Server
    }
}

(compression) {
    encode zstd gzip
}

# --- Services ---

# SearXNG
http://search.example.com {
    import compression
    import standard_headers

    # API and internal health routes
    @api path /config /healthz /stats/errors /stats/checker
    @search path /search
    @imageproxy path /image_proxy
    @static path /static/*

    header @api {
        Access-Control-Allow-Methods "GET, OPTIONS"
        Access-Control-Allow-Origin "*"
    }

    route {
        header Cache-Control "max-age=0, no-store"
        header @search Cache-Control "max-age=5, private"
        header @imageproxy Cache-Control "max-age=604800, public"
        header @static Cache-Control "max-age=31536000, public, immutable"
        
        reverse_proxy searxng:8080 {
            header_up Connection "close"
        }
    }
}

# Pi-hole
http://pihole.example.com {
    import standard_headers
    import compression

    redir / /admin 301
    reverse_proxy pihole:80
}

# Nextcloud
http://nextcloud.example.com {
    import standard_headers
    import compression

    reverse_proxy host.docker.internal:11000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        
        transport http {
            response_header_timeout 3600s
        }
    }
}

# Jellyfin
http://jellyfin.example.com {
    import standard_headers
    
    reverse_proxy jellyfin:8096 {
        flush_interval -1
    }
}
